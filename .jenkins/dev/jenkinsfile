pipeline {
    agent any

    environment{
        DOCKER_PASSWORD = credentials('DOCKER_PASSWORD')
        BITBUCKET_USER_APP = credentials('BITBUCKET_USER_APP')
		BITBUCKET_PASS_APP = credentials('BITBUCKET_PASS_APP')
        DEV_DB_PASSWORD = credentials('DEV_DB_PASSWORD')


    }

    stages {

        stage('Slack-Started'){
            steps{
                slackSend channel: '#deployment',
                color: 'good',
                failOnError: true,
                message: "${env.JOB_NAME} - [${currentBuild.displayName}] Started (<${currentBuild.absoluteUrl}|Open>)",
                teamDomain: 'n-goworkspace',
                tokenCredentialId: 'slack-token'
            }
        }

        stage('Docker Build'){
            steps{
                sh "docker build -f ./.docker/dev/Dockerfile -t ngoco/darbi-new-dev:1.0.${BUILD_NUMBER} ."
            }
        }
       stage('DB Migrate') {
            steps{
                sh script: '''
                #!/bin/bash
                docker run --env DB_CONNECTION=mongodb --env DB_MONGO_HOST="127.0.0.1"  --env DB_MONGO_PORT="27017" --env DB_MONGO_DATABASE="Darbi-dev-db" --env DB_MONGO_DSN="mongodb+srv://n-go-staging-dbuser:GXmszz6ZzhUykBJR@n-go-staging-cluster.tz2jf.mongodb.net/n-go-staging-db?authSource=admin&replicaSet=atlas-2kkart-shard-0&w=majority&readPreference=primary&appname=MongoDB%20Compass&retryWrites=true&ssl=true" --env APP_ENV=jenkins ngoco/darbi-new-dev:1.0.${BUILD_NUMBER} php artisan migrate 
                '''
            }
        }



        stage('Dockerhub Push') {
            steps{
                sh(script: """
                docker login -u ngoco -p $DOCKER_PASSWORD
                """, returnStdout: true)
                sh "docker push ngoco/darbi-new-dev:1.0.${BUILD_NUMBER} "
            }
        }

        stage('Manifest Update'){
            steps{
                sh(script: """
                    git config --global user.email "app.support@n-go.co"
                    git config --global user.name "app-ngo"
                    rm -Rf darbi-dev-manifest
                    git clone https://$BITBUCKET_USER_APP:$BITBUCKET_PASS_APP@bitbucket.org/n-go-devops/darbi-dev-manifest.git
                    cd darbi-dev-manifest/
                    sed -i 's/darbi-new-dev:.*/darbi-new-dev:1.0.${BUILD_NUMBER}/g' Darbi-New/darbi-new-dev-deployment.yaml
                    git add .
                    git commit -m 'Update to the latest version'
                    git push origin master
                    cd ..
                    rm -Rf darbi-dev-manifest
                """)
            }
        }

        stage('Cleanup Workspace') {
            steps{
                sh(script: """
                    docker image rm -f ngoco/darbi-new-dev:1.0.${BUILD_NUMBER}
                """)

            }
        }

        stage('Deployment') {
            steps{
                sh(script: """
                    echo 'waiting for Deployment'
                    sleep 30
                """)

            }
        }
    }

  post {
        success {
                  slackSend (color: '#00FF00', message: "${env.JOB_NAME} - [${currentBuild.displayName}] SUCCESS after ${currentBuild.durationString.replace(' and counting', '')} (<${currentBuild.absoluteUrl}|Open>)")
        }

        failure {
                 slackSend (color: '#FF0000', message: "${env.JOB_NAME} - [${currentBuild.displayName}] FAILED (<${currentBuild.absoluteUrl}|Open>)")
        }
    }

}
